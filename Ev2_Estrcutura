import datetime
import time

Separador = ("_" * 60) + "\n"
Salas= {}
Reservas = {}
Clientes= {}
Fecha_capturada = ""
Salas_libres = {}

from openpyxl import Workbook
import openpyxl
from openpyxl.styles import Font
from openpyxl.styles.alignment import Alignment

exportar= openpyxl.Workbook()
exportar.iso_dates = True
hoja = exportar.active
hoja.title = 'Reservaciones'

while True:
    print(Separador)
    print("MENÚ PRINCIPAL")
    print(Separador)
    print("A. Reservaciones")
    print("B. Reportes")
    print("C. Registrar sala")
    print("D. Registrar un cliente")
    print("E. Salir  \n")
    opcion = input("Ingrese la opción:  \n")
    
    if opcion.upper() == "A":
        print(Separador)
        print("SUBMENÚ RESERVACIONES")
        print(Separador)
        while True:
            print("A1. Registrar nueva reservación")
            print("A2. Modificar descripción de una reservación")
            print("A3. Consultar disponibilidad de salas para una fecha")
            print("A4. Salir")
            opcion2 = input("Ingrese la opción:  \n").lower()
            if opcion2 == "a1":
                Clave_cliente = int(input("Ingresa la clave de cliente: \n"))

                ID_clientes = [clave for clave in Clientes.keys()]

                if Clave_cliente in ID_clientes:
                  Fecha_capturada = input("Ingresa la fecha en la que quiera reservar (DD/MM/AAAA):\n")
                  fecha_reservacion = datetime.datetime.strptime(Fecha_capturada, "%d/%m/%Y").date()
                  fecha_actual = datetime.date.today()
                  fecha_valida = fecha_reservacion - datetime.timedelta(days=2)

                  if fecha_actual <= fecha_valida:
                    clave_sala = int(input("Ingresa el ID de la sala: \n"))

                    clave_salas = [clave for clave in Salas.keys()]

                    if clave_sala in clave_salas:
                      turno = input("(M)atutino \n (V)espertino \n (N)octurno \n Ingresa la letra inicial del turno:\n")

                      if turno.upper() == 'M':
                        turno = 'Matituno'
                      elif turno.upper() == 'V':
                        turno = 'Vespertino'
                      elif turno.upper() == 'N':
                        turno = 'Nocturno'

                      coincidencias = 0
                      for sala, fecha, cliente, nombre, turno_reservacion in Reservas.values():
                        if (clave_sala == sala) and (fecha_reservacion == fecha) and (turno == turno_reservacion):
                          coincidencias += 1

                      if coincidencias == 0:
                        nombre_reservacion = input("Ingresa el nombre del evento: \n")

                        clave_reservacion = max(list(Reservas.keys()), default = 0) + 1

                        for clave_registrada, [nombre] in Clientes.items():
                          if Clave_cliente == clave_registrada:
                            nombre_cliente = nombre

                        Reservas[clave_reservacion] = [clave_sala, fecha_reservacion, nombre_cliente, nombre_reservacion, turno]

                        print(f"Clave de reservacion: {clave_reservacion}\n")

                      else:
                        print("Este turno ya esta ocupado\n")
                    else:
                      print("Esta sala no existe\n")
                  else:
                    print("La reservación no cumple con los dos dias de anticipo\n")
                else:
                  print("El cliente no existe\n")                
                
            if opcion2 == "a2":
                clave = int(input("Ingresa la clave de la reservación: \n"))

                if clave in Reservas.keys():
                  nombre_nuevo = input("Ingresa nuevo nombre del evento: \n")

                  for clave_registrada, [sala, fecha, cliente, nombre, turno_reservacion] in Reservas.items():
                    if clave == clave_registrada:
                      Reservas.update({clave_registrada: [sala, fecha, cliente, nombre_nuevo, turno_reservacion]})

                      print(f"El nuevo nombre del evento es: {nombre_nuevo}\n")

                else:
                  print("Ingresa una clave de reservación válida\n")
            
            if opcion2 == "a3":
                fecha_solicitada = input("Ingresa la fecha del evento (dd/mm/aaaa): \n")
                fecha_modificada = datetime.datetime.strptime(Fecha_capturada, "%d/%m/%Y").date()
                convertidor = set(Reservas)
                
                for sala in Salas.keys():
                  for turno in Reservas.values():
                    Salas_libres.append((sala,turno))
                    Combicacion_posible =set(Salas_libres)
                    Salas_libres =sorted(list(Combicacion_posible - convertidor))
                    print(Salas_libres)  
                    
                # print(Separador)
                # print("*" + " "*13 + f"REPORTE DE RESERVACIONES PARA EL DÍA {fecha_solicitada}" + " "*13 + "*")
                # print(Separador)

                # print("{:<6} {:<20} {:<38} {:<13}".format('SALA','CLIENTE','EVENTO', 'TURNO'))
                # print("*"*77)

                # for clave_registrada, [sala, fecha, cliente, nombre, turno_reservacion] in reservaciones.items():
                #   if fecha_modificada == fecha:
                #     print("{:<6} {:<20} {:<38} {:<13}".format(sala, cliente, nombre, turno_reservacion))        
                #     print(""*30 + " FIN DEL REPORTE " + ""*30)
            
            if opcion2=="a4":
              print("Saliendo del menu de reservas...")
              break        
    
    elif opcion.upper() == "B":
        print(Separador)
        print("SUBMENÚ REPORTES")
        print(Separador)
        while True:
            print("B1. Reporte en pantalla de reservaciones para una fecha")
            print("B2. Exportar reporte tabular en Excel")
            opcion2 = input("Ingrese la opción:  \n")
            if opcion2 == "B1":
                    fecha_solicitada = input("Ingrese la fecha del evento (dd/mm/aaaa): \n")
                    fecha_modificada = datetime.datetime.strptime(Fecha_capturada, "%d/%m/%Y").date()

                    print(Separador)
                    print("*" + " "*13 + f"REPORTE: {fecha_solicitada}" + " "*13 + "*")
                    print("")
                    print("{:<6} {:<20} {:<38} {:<13}".format('SALA','CLIENTE','EVENTO', 'TURNO'))
                    print(Separador)

                    for clave_registrada, [sala, fecha, cliente, nombre, turno_reservacion] in Reservas.items():
                      if fecha_modificada == fecha:
                        print("{:<6} {:<20} {:<38} {:<13}".format(sala, cliente, nombre, turno_reservacion))        
                    print(Separador)
        
            elif opcion2 == "B2":
                
                    print("Exportando reporte a Excel \n")
                    print("... \n")
                    
                    hoja.merge_cells('A1:H1')
                    hoja['A1']=f'REPORTE DE RESERVACIONES DEL DÍA {fecha_solicitada}'
                    hoja['A1'].font = Font(bold=True, size = 16)
                    hoja.sheet_properties.tabColor = 'dfdb6d'
                    hoja['A1'].alignment = Alignment (horizontal ='center')

                    hoja.merge_cells('A2:B2')
                    hoja.merge_cells('C2:D2')
                    hoja.merge_cells('E2:F2')
                    hoja.merge_cells('G2:H2')
                    hoja['A2']= 'SALA'
                    hoja['A2'].alignment = Alignment (horizontal='center')
                    hoja['C2']= 'CLIENTE'
                    hoja['c2'].alignment = Alignment (horizontal='center')
                    hoja['E2']= 'EVENTO'
                    hoja['E2'].alignment = Alignment (horizontal='center')
                    hoja['G2']= 'TURNO'
                    hoja['G2'].alignment = Alignment (horizontal='center')
                    hoja.merge_cells('A3:B3')
                    hoja.merge_cells('C3:D3')
                    hoja.merge_cells('E3:F3')
                    hoja.merge_cells('G3:H3')

                    hoja['A3'].value = clave_sala
                    hoja['A3'].alignment = Alignment (horizontal='center')

                    hoja['C3'].value = nombre_cliente
                    hoja['C3'].alignment = Alignment (horizontal='center')

                    hoja['E3'].value = nombre_reservacion
                    hoja['E3'].alignment = Alignment (horizontal='center')

                    hoja['G3'].value = turno_reservacion
                    hoja['G3'].alignment = Alignment (horizontal='center')


                    exportar.save('Ev2_Reporte.xlsx')
                    
                    print("Reporte exportado con éxito \n")
                    
            else:
                    print("Ingrese una respuesta válida \n")
            
    elif opcion.upper() == "C":
        nombre_sala = input("Ingrese el nombre de la sala: \n")
        capacidad=int(input("Ingrese la capacidad de la sala: \n"))

        clave_sala = max(list(Salas.keys()), default = 0) + 1

        Salas[clave_sala] = [nombre_sala,capacidad]

        print(f"Sala registrada, clave de nueva sala: {clave_sala}\n")
    
    elif opcion.upper() == "D":
        nombre_cliente = input("Ingrese el nombre del cliente: \n")
        Clave_cliente = max(list(Clientes.keys()), default = 0) + 1
        
        Clientes[Clave_cliente] = [nombre_cliente]

        print(f"Cliente registrado, clave de nuevo cliente: {Clave_cliente}\n")
    
    elif opcion.upper() == "E":
        break

    else:
        print("Ingrese una respuesta válida: \n")
        
